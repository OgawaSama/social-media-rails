<%# app/views/event_availabilities/show.html.erb %>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-center text-blue-600 mb-4">Marcar Disponibilidade</h1>
  <h2 class="text-xl font-semibold text-center text-gray-700 mb-8"><%= @event.title %></h2>

  <%= form_with url: event_my_availability_path(@event), method: :patch, local: true, data: { turbo: false } do |form| %>
    <div class="overflow-x-auto bg-white shadow-md rounded-lg p-6">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">
              Data / Horário
            </th>
            <%# Cabeçalho das Opções %>
            <% Availability::STATUS.keys.each do |status_key| %>
              <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= status_key.to_s.humanize %>
              </th>
            <% end %>
            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Não sei / Limpar
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @time_slots_by_day.each do |date, slots| %>
            <%# Linha de Data %>
            <tr class="bg-gray-100">
              <td colspan="<%= Availability::STATUS.count + 2 %>" class="px-3 py-2 text-sm font-semibold text-gray-700">
                <%= l(date, format: :long) %>
              </td>
            </tr>
            <%# Linha para cada Slot %>
            <% slots.each do |slot| %>
              <tr>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white z-10">
                  <%= slot.start_time.strftime("%H:%M") %> - <%= slot.end_time.strftime("%H:%M") %>
                </td>
                <% current_status = @my_availabilities[slot.id]&.status %>
                <%# Botões de Rádio para cada status %>
                <% Availability::STATUS.keys.each do |status_key| %>
                  <td class="px-3 py-3 text-center">
                    <%= radio_button_tag "availabilities[#{slot.id}]", status_key, current_status == status_key, class: "form-radio h-5 w-5 text-blue-600" %>
                  </td>
                <% end %>
                <%# Opção para "limpar" (não enviar valor) %>
                <td class="px-3 py-3 text-center">
                   <%= radio_button_tag "availabilities[#{slot.id}]", "", current_status.nil?, class: "form-radio h-5 w-5 text-gray-600" %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# Botão de Envio %>
    <div class="flex justify-center mt-8">
      <%= form.submit "Salvar Minha Disponibilidade", class: "bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-lg transition duration-200 cursor-pointer" %>
    </div>
  <% end %>

  <div class="mt-6 text-center">
    <%= link_to "Ver Grade Completa", event_path(@event), class: "text-gray-600 hover:text-gray-800 mr-4" %>
    <%= link_to "Cancelar", event_path(@event), class: "text-gray-600 hover:text-gray-800" %>
  </div>
</div>

<%# Estilo para sticky (repetido, idealmente vai pro CSS global) %>
<style>
  .sticky {
    position: -webkit-sticky; /* Safari */
    position: sticky;
  }
</style>